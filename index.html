<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiaoCarb</title>
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
	<link rel="icon" href="icon-192.png">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray-50: #f8f9fa;
            --gray-100: #f0f0f0;
            --gray-200: #e0e0e0;
            --gray-600: #6c757d;
            --gray-900: #333;
            --text-size-base: 18px;
            --text-size-large: 20px;
            --text-size-xl: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            padding: 20px 20px 100px 20px;
            font-size: var(--text-size-base);
        }

        body.extra-large-text {
            --text-size-base: 22px;
            --text-size-large: 24px;
            --text-size-xl: 28px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: var(--gray-900);
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: white;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            color: white;
        }

        /* ONBOARDING */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            display: none;
        }

        .onboarding.show {
            display: flex;
            flex-direction: column;
        }

        .onboarding-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
        }

        .onboarding-illustration {
            font-size: 120px;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .onboarding h2 {
            font-size: 32px;
            color: var(--gray-900);
            margin-bottom: 15px;
        }

        .onboarding-text {
            font-size: var(--text-size-large);
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 30px;
            max-width: 400px;
        }

        .onboarding-steps {
            text-align: left;
            margin: 30px 0;
        }

        .onboarding-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .step-number {
            font-size: 28px;
            min-width: 40px;
        }

        .step-text {
            font-size: var(--text-size-base);
            line-height: 1.5;
        }

        .onboarding-dots {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-200);
            transition: all 0.3s;
        }

        .dot.active {
            background: var(--primary);
            width: 32px;
            border-radius: 6px;
        }

        .onboarding-buttons {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .skip-btn {
            flex: 1;
            padding: 18px;
            background: var(--gray-100);
            color: var(--gray-900);
            border: none;
            border-radius: 15px;
            font-size: var(--text-size-base);
            font-weight: 600;
            cursor: pointer;
        }

        .next-btn {
            flex: 2;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: var(--text-size-base);
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* CARDS */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: var(--gray-100);
            padding: 5px;
            border-radius: 15px;
        }

        .tab {
            flex: 1;
            padding: 18px 12px;
            border: none;
            background: transparent;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-icon {
            font-size: 24px;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* WIZARD */
        .wizard {
            display: none;
        }

        .wizard.active {
            display: block;
        }

        .wizard-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .wizard-step-indicator {
            flex: 1;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            transition: all 0.3s;
        }

        .wizard-step-indicator.completed {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .wizard-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .wizard-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: var(--text-size-large);
            font-weight: 700;
            cursor: pointer;
            min-height: 64px;
        }

        .wizard-btn-back {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .wizard-btn-next {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* FORMS */
        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--gray-900);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-900);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 18px;
            font-size: var(--text-size-large);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.error {
            border-color: var(--danger);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-message {
            color: var(--danger);
            font-size: 15px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .helper-text {
            font-size: 15px;
            color: var(--gray-600);
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: var(--text-size-base);
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* BUTTONS */
        .btn {
            width: 100%;
            padding: 22px;
            border: none;
            border-radius: 15px;
            font-size: var(--text-size-large);
            font-weight: 700;
            cursor: pointer;
            min-height: 64px;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        /* PHOTO */
        .photo-box {
            border: 3px dashed var(--gray-200);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            background: var(--gray-50);
            transition: all 0.3s;
        }

        .photo-box.has-image {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-box h4 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--gray-900);
        }

        .photo-tip {
            font-size: 15px;
            color: var(--gray-600);
            margin-bottom: 15px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: zoom-in;
            touch-action: pinch-zoom;
        }

        .preview-image.zoomed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95vw;
            max-height: 95vh;
            z-index: 1500;
            cursor: zoom-out;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 0;
        }

        .zoom-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1400;
        }

        .zoom-overlay.show {
            display: block;
        }

        .camera-input {
            display: none;
        }

        /* ALERTS */
        .alert {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }

        .alert-warning {
            background: #fff3cd;
            border: 2px solid var(--warning);
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border: 2px solid var(--danger);
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }

        .alert-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 17px;
        }

        .alert.hidden {
            display: none;
        }

        /* RESULTS */
        .verdict-card {
            text-align: center;
            padding: 35px 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .verdict-emoji {
            font-size: 72px;
            margin-bottom: 15px;
            animation: bounceIn 0.6s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .verdict-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .verdict-text {
            font-size: var(--text-size-large);
            opacity: 0.9;
        }

        .portion-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 35px 25px;
            border-radius: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            margin: 25px 0;
        }

        .portion-label {
            font-size: var(--text-size-large);
            font-weight: 600;
            margin-bottom: 12px;
            opacity: 0.95;
        }

        .portion-value {
            font-size: 72px;
            font-weight: 700;
            line-height: 1;
            margin: 15px 0;
        }

        .portion-sub {
            font-size: 17px;
            opacity: 0.9;
        }

        /* CATALOG */
        .food-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            position: relative;
        }

        .food-card:active {
            transform: scale(0.98);
        }

        .food-card-header {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .food-image {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-size: var(--text-size-large);
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--gray-900);
        }

        .food-type {
            font-size: 15px;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .food-score {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
        }

        .food-score.verde {
            background: var(--success);
            color: white;
        }

        .food-score.giallo {
            background: var(--warning);
            color: var(--gray-900);
        }

        .food-score.rosso {
            background: var(--danger);
            color: white;
        }

        .food-score.grigio {
            background: var(--gray-600);
            color: white;
        }

        .food-portion {
            background: var(--gray-50);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .portion-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .use-today-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        .food-details {
            margin-top: 15px;
        }

        details {
            cursor: pointer;
        }

        summary {
            padding: 12px;
            background: var(--gray-50);
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        .details-content {
            padding: 15px;
            margin-top: 10px;
            font-size: 15px;
            line-height: 1.6;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .delete-btn {
            padding: 10px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
        }

        .empty-illustration {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: var(--text-size-xl);
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--gray-900);
        }

        .empty-text {
            font-size: var(--text-size-base);
            color: var(--gray-600);
            line-height: 1.6;
        }

        .empty-action {
            margin-top: 25px;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 25px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid var(--gray-100);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: var(--text-size-base);
            color: var(--primary);
            font-weight: 600;
        }

        /* INFO MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 20px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-600);
            cursor: pointer;
            border: none;
            background: none;
            padding: 5px 10px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--gray-900);
        }

        .modal-text {
            font-size: var(--text-size-base);
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }

        .modal-example {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 16px;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-left: 6px;
            vertical-align: middle;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* TIP BANNER */
        .tip-banner {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border: 2px solid var(--warning);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .tip-icon {
            font-size: 28px;
        }

        .tip-content {
            flex: 1;
        }

        .tip-title {
            font-weight: 700;
            font-size: 17px;
            margin-bottom: 5px;
        }

        .tip-text {
            font-size: 15px;
            line-height: 1.5;
        }

        .tip-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        /* SETTINGS */
        .settings-group {
            margin-bottom: 25px;
            padding: 18px;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .settings-label {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 17px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-200);
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* SUCCESS ANIMATION */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1500;
            text-align: center;
            display: none;
        }

        .success-animation.show {
            display: block;
            animation: popIn 0.5s;
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .success-checkmark {
            font-size: 80px;
            color: var(--success);
            margin-bottom: 15px;
        }

        .success-text {
            font-size: var(--text-size-xl);
            font-weight: 700;
            color: var(--gray-900);
        }

        /* SHARE SHEET */
        .share-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 1100;
        }

        .share-sheet.show {
            transform: translateY(0);
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .share-option {
            text-align: center;
            cursor: pointer;
        }

        .share-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 28px;
        }

        .share-label {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* ADVANCED COLLAPSE */
        .advanced-section {
            margin-top: 20px;
        }

        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--gray-50);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
        }

        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .advanced-content.show {
            max-height: 1000px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê± Cibo per Diabetici</h1>
            <p>Analisi e porzioni personalizzate</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('catalog')">
                    <span class="tab-icon">üìö</span>
                    <span>Catalogo</span>
                </button>
                <button class="tab" onclick="switchTab('food')">
                    <span class="tab-icon">üçΩÔ∏è</span>
                    <span>Cibo</span>
                </button>
                <button class="tab" onclick="switchTab('profile')">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span>Profilo</span>
                </button>
            </div>

            <!-- CATALOG TAB -->
            <div id="catalog" class="tab-content active">
                <div id="tipBanner"></div>
                <div id="foodList"></div>
            </div>

            <!-- FOOD TAB with WIZARD -->
            <div id="food" class="tab-content">
                <!-- Step 1: Basic Info -->
                <div id="foodStep1" class="wizard active">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator"></div>
                        <div class="wizard-step-indicator"></div>
                    </div>

                    <div class="section-title">Informazioni Base</div>

                    <div class="form-group">
                        <label for="foodName">Nome Prodotto *</label>
                        <input type="text" id="foodName" placeholder="es. Royal Canin Diabetic" required>
                        <p class="error-message" id="nameError">Inserisci il nome del prodotto</p>
                    </div>

                    <div class="photo-box" id="photoBox">
                        <h4>üì¶ Foto Confezione</h4>
                        <p class="photo-tip">Per riconoscere il prodotto</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" type="button" onclick="document.getElementById('frontCameraInput').click()" style="flex: 1;">
                                üì∑ Scatta
                            </button>
                            <button class="btn btn-secondary" type="button" onclick="document.getElementById('frontGalleryInput').click()" style="flex: 1;">
                                üñºÔ∏è Galleria
                            </button>
                        </div>
                        <input type="file" id="frontCameraInput" class="camera-input" accept="image/*" capture>
                        <input type="file" id="frontGalleryInput" class="camera-input" accept="image/*">
                        <img id="frontPreview" class="preview-image" alt="Confezione">
                        <div id="frontCropControls" style="display: none; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="confirmFrontPhoto()" style="margin-bottom: 10px;">
                                ‚úì Usa Questa Foto
                            </button>
                            <button class="btn btn-secondary" onclick="retakeFrontPhoto()">
                                ‚Üª Rifai Foto
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="foodType">Tipo Cibo *</label>
                        <select id="foodType">
                            <option value="wet">üü¶ Umido</option>
                            <option value="dry">üü§ Secco</option>
                        </select>
                    </div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-next" onclick="goToStep(2)">
                            Avanti ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: Nutrients -->
                <div id="foodStep2" class="wizard">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator"></div>
                    </div>

                    <div class="section-title">Valori Nutrizionali</div>

                    <div class="tip-banner" id="ocrTipBanner" style="display: none;">
                        <div class="tip-icon">üí°</div>
                        <div class="tip-content">
                            <div class="tip-title">Prova la lettura automatica!</div>
                            <div class="tip-text">
                                <a href="#" class="tip-link" onclick="showOCR(); return false;">Scatta foto dell'etichetta</a> e proviamo a leggere i valori
                            </div>
                        </div>
                    </div>

                    <div id="ocrSection" style="display: none;">
                        <div class="photo-box">
                            <h4>üè∑Ô∏è Foto Etichetta Nutrizionale</h4>
                            <p class="photo-tip">üìê Inquadra SOLO la tabella nutrizionale per risultati migliori</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" type="button" onclick="document.getElementById('labelCameraInput').click()" style="flex: 1;">
                                    üì∑ Scatta
                                </button>
                                <button class="btn btn-secondary" type="button" onclick="document.getElementById('labelGalleryInput').click()" style="flex: 1;">
                                    üñºÔ∏è Galleria
                                </button>
                            </div>
                            <input type="file" id="labelCameraInput" class="camera-input" accept="image/*" capture>
                            <input type="file" id="labelGalleryInput" class="camera-input" accept="image/*">
                            <img id="labelPreview" class="preview-image" alt="Etichetta">
                            
                            <div id="labelCropControls" style="display: none; margin-top: 15px;">
                                <canvas id="cropCanvas" style="max-width: 100%; border: 2px solid var(--primary); border-radius: 8px; cursor: crosshair; display: none;"></canvas>
                                <div style="margin-top: 15px;">
                                    <p style="font-size: 14px; color: var(--gray-600); margin-bottom: 10px;">
                                        üí° Clicca e trascina per ritagliare solo la tabella nutrizionale
                                    </p>
                                    <button class="btn btn-primary" onclick="applyCrop()" style="margin-bottom: 10px;">
                                        ‚úÇÔ∏è Ritaglia e Analizza
                                    </button>
                                    <button class="btn btn-secondary" onclick="skipCrop()" style="margin-bottom: 10px;">
                                        ‚è≠Ô∏è Salta Ritaglio
                                    </button>
                                    <button class="btn btn-secondary" onclick="retakeLabelPhoto()">
                                        ‚Üª Rifai Foto
                                    </button>
                                </div>
                            </div>
                            
                            <div class="loading" id="loadingOCR">
                                <div class="spinner"></div>
                                <div class="loading-text">Lettura in corso...</div>
                            </div>
                        </div>
                    </div>

                    <p style="font-size: 16px; color: var(--gray-600); margin-bottom: 15px;">
                        Inserisci i valori % come indicato sulla confezione
                    </p>

                    <div class="nutrition-grid">
                        <div class="form-group">
                            <label for="protein">Proteine (Protein) % *</label>
                            <input type="number" id="protein" step="0.1" placeholder="es. 38" required>
                        </div>

                        <div class="form-group">
                            <label for="fat">Grassi (Fat) % *</label>
                            <input type="number" id="fat" step="0.1" placeholder="es. 8.5" required>
                        </div>

                        <div class="form-group">
                            <label for="fiber">Fibre (Fiber) % *</label>
                            <input type="number" id="fiber" step="0.1" placeholder="es. 4.3" required>
                        </div>

                        <div class="form-group">
                            <label for="moisture">Umidit√† (Moisture) % *</label>
                            <input type="number" id="moisture" step="0.1" placeholder="es. 12" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ash">Ceneri (Ash) %</label>
                        <input type="number" id="ash" step="0.1" placeholder="es. 6">
                        <p class="helper-text">Se indicato sulla confezione, inseriscilo qui</p>
                    </div>

                    <!-- Advanced section -->
                    <div class="advanced-section">
                        <div class="advanced-toggle" onclick="toggleAdvanced()">
                            <span id="advancedArrow">‚ñ∂</span>
                            <span>Opzioni Avanzate</span>
                        </div>
                        <div class="advanced-content" id="advancedContent">
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="kcalPer100g">Energia (kcal/100g)</label>
                                <input type="number" id="kcalPer100g" step="0.1" placeholder="Solo se dichiarato">
                                <p class="helper-text">Lascia vuoto per calcolo automatico</p>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-back" onclick="goToStep(1)">
                            ‚Üê Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-next" onclick="analyzeFood()">
                            Analizza ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div id="foodStep3" class="wizard">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                    </div>

                    <div id="analysisResults"></div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-back" onclick="goToStep(2)">
                            ‚Üê Modifica
                        </button>
                        <button class="wizard-btn wizard-btn-next" onclick="saveFood()">
                            üíæ Salva
                        </button>
                    </div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile" class="tab-content">
                <div class="section-title">Profilo del Gatto</div>

                <!-- Simple mode -->
                <div id="simpleProfile">
                    <div class="form-group">
                        <label for="catName">Nome</label>
                        <input type="text" id="catName" placeholder="es. Micio">
                    </div>

                    <div class="form-group">
                        <label for="currentWeight">Peso (kg) *</label>
                        <input type="number" id="currentWeight" step="0.1" value="5.0" required>
                    </div>

                    <div style="background: var(--gray-50); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üíä</span>
                            <div>
                                <div style="font-weight: 600; font-size: 17px;">Gatto diabetico</div>
                                <div style="font-size: 14px; color: var(--gray-600);">App dedicata a gatti con diabete</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced section -->
                <div class="advanced-section">
                    <div class="advanced-toggle" onclick="toggleProfileAdvanced()">
                        <span id="profileAdvancedArrow">‚ñ∂</span>
                        <span>Impostazioni Avanzate</span>
                    </div>
                    <div class="advanced-content" id="profileAdvancedContent">
                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="idealWeight">Peso Ideale (kg)</label>
                                <input type="number" id="idealWeight" step="0.1" value="5.0">
                                <p class="helper-text">Per calcolare porzioni in dimagrimento</p>
                            </div>

                            <div class="form-group">
                                <label for="catStatus">Stato</label>
                                <select id="catStatus">
                                    <option value="neutered">Sterilizzato</option>
                                    <option value="intact">Intero</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="goal">Obiettivo</label>
                                <select id="goal">
                                    <option value="maintenance">Mantenimento peso</option>
                                    <option value="weight-loss">Dimagrimento</option>
                                </select>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="onInsulin">
                                <label for="onInsulin">In terapia insulinica</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger hidden" id="insulinWarning">
                    <div class="alert-title">‚ö†Ô∏è ATTENZIONE - Terapia Insulinica</div>
                    Qualsiasi cambio di dieta pu√≤ richiedere aggiustamento dell'insulina. Consultare sempre il veterinario prima di modificare l'alimentazione.
                </div>

                <button class="btn btn-primary" onclick="saveProfile()">üíæ Salva Profilo</button>
                <button class="btn btn-danger" onclick="deleteProfile()" style="margin-top: 15px;">üóëÔ∏è Elimina Profilo</button>

                <div id="profileSummary" style="display: none; margin-top: 25px;">
                    <div class="portion-card">
                        <div class="portion-label">
                            Fabbisogno Energetico
                            <span class="info-icon" onclick="showInfo('energy')">?</span>
                        </div>
                        <div id="profileCalories"></div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section-title" style="margin-top: 40px;">Impostazioni App</div>

                <div class="settings-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="settings-label">Testo Extra Large</div>
                            <p style="font-size: 14px; color: var(--gray-600);">Per una lettura pi√π facile</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="extraLargeText" onchange="toggleTextSize()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-content" id="onboardingScreen1">
            <div class="onboarding-illustration">üê±</div>
            <h2>Benvenuta!</h2>
            <p class="onboarding-text">
                Ti aiutiamo a scegliere il cibo migliore per il tuo gatto diabetico
            </p>
            <div class="onboarding-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="skip-btn" onclick="skipOnboarding()">Salta</button>
            <button class="next-btn" onclick="nextOnboarding(2)">Inizia ‚Üí</button>
        </div>
    </div>

    <div class="onboarding" id="onboarding2">
        <div class="onboarding-content">
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="step-number">1Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Crea il profilo</strong><br>
                        Nome e peso del gatto
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="step-number">2Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Fotografa il cibo</strong><br>
                        Inseriamo i valori nutrizionali
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="step-number">3Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Vedi se √® adatto</strong><br>
                        Punteggio e porzione giusta
                    </div>
                </div>
            </div>
            <div class="onboarding-dots">
                <div class="dot"></div>
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="skip-btn" onclick="skipOnboarding()">Salta</button>
            <button class="next-btn" onclick="nextOnboarding(3)">Avanti ‚Üí</button>
        </div>
    </div>

    <div class="onboarding" id="onboarding3">
        <div class="onboarding-content">
            <div class="onboarding-illustration">üí°</div>
            <h2>Consiglio!</h2>
            <p class="onboarding-text">
                Salva i cibi che usi sempre nel catalogo.<br><br>
                Cos√¨ trovi subito le porzioni senza ricalcolare ogni volta!
            </p>
            <div class="onboarding-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot active"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="next-btn" style="flex: 1;" onclick="completeOnboarding()">Inizia! üéâ</button>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeInfo()">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Success Animation -->
    <div class="success-animation" id="successAnimation">
        <div class="success-checkmark">‚úì</div>
        <div class="success-text">Salvato!</div>
    </div>

    <!-- Share Sheet -->
    <div class="share-sheet" id="shareSheet">
        <h3 style="margin-bottom: 10px;">Condividi</h3>
        <div class="share-options">
            <div class="share-option" onclick="shareVia('whatsapp')">
                <div class="share-icon">üí¨</div>
                <div class="share-label">WhatsApp</div>
            </div>
            <div class="share-option" onclick="shareVia('email')">
                <div class="share-icon">üìß</div>
                <div class="share-label">Email</div>
            </div>
            <div class="share-option" onclick="shareVia('copy')">
                <div class="share-icon">üìã</div>
                <div class="share-label">Copia</div>
            </div>
            <div class="share-option" onclick="closeShare()">
                <div class="share-icon">‚úï</div>
                <div class="share-label">Chiudi</div>
            </div>
        </div>
    </div>

    <!-- Zoom Overlay -->
    <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()"></div>

    <script>
        // ============= STATE =============
        let frontImage = null;
        let labelImage = null;
        let currentAnalysis = null;
        let catProfile = null;
        let currentWizardStep = 1;
        let shareData = null;
        let cropStartX = 0;
        let cropStartY = 0;
        let cropEndX = 0;
        let cropEndY = 0;
        let isCropping = false;
        let originalLabelImage = null;

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            loadCatalog();
            checkOnboarding();
            loadSettings();
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // Photo handlers - both camera and gallery
            document.getElementById('frontCameraInput').addEventListener('change', handleFrontPhoto);
            document.getElementById('frontGalleryInput').addEventListener('change', handleFrontPhoto);
            document.getElementById('labelCameraInput').addEventListener('change', handleLabelPhoto);
            document.getElementById('labelGalleryInput').addEventListener('change', handleLabelPhoto);
            
            // Insulin warning
            document.getElementById('onInsulin').addEventListener('change', function() {
                document.getElementById('insulinWarning').classList.toggle('hidden', !this.checked);
            });

            // Click outside modal to close
            document.getElementById('infoModal').addEventListener('click', function(e) {
                if (e.target === this) closeInfo();
            });

            // Click outside share sheet to close
            document.getElementById('shareSheet').addEventListener('click', function(e) {
                if (e.target === this) closeShare();
            });
        }

        // ============= ONBOARDING =============
        function checkOnboarding() {
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
            if (!hasSeenOnboarding) {
                document.getElementById('onboarding').classList.add('show');
            }
        }

        function nextOnboarding(screen) {
            document.getElementById('onboarding').classList.remove('show');
            if (screen === 2) {
                document.getElementById('onboarding2').classList.add('show');
            } else if (screen === 3) {
                document.getElementById('onboarding2').classList.remove('show');
                document.getElementById('onboarding3').classList.add('show');
            }
        }

        function skipOnboarding() {
            document.getElementById('onboarding').classList.remove('show');
            document.getElementById('onboarding2').classList.remove('show');
            document.getElementById('onboarding3').classList.remove('show');
            localStorage.setItem('hasSeenOnboarding', 'true');
        }

        function completeOnboarding() {
            document.getElementById('onboarding3').classList.remove('show');
            localStorage.setItem('hasSeenOnboarding', 'true');
            // Navigate to profile
            switchTab('profile');
        }

        // ============= TAB SWITCHING =============
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'catalog') {
                loadCatalog();
            } else if (tabName === 'food') {
                resetWizard();
            }
        }

        // ============= WIZARD NAVIGATION =============
        function goToStep(step) {
            // Validation
            if (step === 2 && currentWizardStep === 1) {
                const name = document.getElementById('foodName').value.trim();
                if (!name) {
                    document.getElementById('foodName').classList.add('error');
                    document.getElementById('nameError').classList.add('show');
                    setTimeout(() => {
                        document.getElementById('foodName').classList.remove('error');
                        document.getElementById('nameError').classList.remove('show');
                    }, 3000);
                    return;
                }
            }

            // Hide all steps
            document.querySelectorAll('.wizard').forEach(w => w.classList.remove('active'));
            
            // Show target step
            document.getElementById('foodStep' + step).classList.add('active');
            currentWizardStep = step;

            // Show OCR tip on step 2
            if (step === 2) {
                document.getElementById('ocrTipBanner').style.display = 'flex';
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetWizard() {
            currentWizardStep = 1;
            document.querySelectorAll('.wizard').forEach(w => w.classList.remove('active'));
            document.getElementById('foodStep1').classList.add('active');
            
            // Clear form
            document.getElementById('foodName').value = '';
            document.getElementById('foodType').value = 'wet';
            document.getElementById('protein').value = '';
            document.getElementById('fat').value = '';
            document.getElementById('fiber').value = '';
            document.getElementById('moisture').value = '';
            document.getElementById('ash').value = '';
            document.getElementById('kcalPer100g').value = '';
            
            frontImage = null;
            labelImage = null;
            document.getElementById('frontPreview').style.display = 'none';
            document.getElementById('labelPreview').style.display = 'none';
            document.getElementById('photoBox').classList.remove('has-image');
            document.getElementById('ocrSection').style.display = 'none';
            document.getElementById('ocrTipBanner').style.display = 'none';
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const arrow = document.getElementById('advancedArrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '‚ñº' : '‚ñ∂';
        }

        function toggleProfileAdvanced() {
            const content = document.getElementById('profileAdvancedContent');
            const arrow = document.getElementById('profileAdvancedArrow');
            content.classList.toggle('show');
            arrow.textContent = content.classList.contains('show') ? '‚ñº' : '‚ñ∂';
        }

        // ============= PHOTO HANDLING =============
        function handleFrontPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                frontImage = event.target.result;
                const preview = document.getElementById('frontPreview');
                preview.src = frontImage;
                preview.style.display = 'block';
                preview.onclick = () => toggleZoom(preview);
                document.getElementById('photoBox').classList.add('has-image');
                document.getElementById('frontCropControls').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function confirmFrontPhoto() {
            document.getElementById('frontCropControls').style.display = 'none';
        }

        function retakeFrontPhoto() {
            frontImage = null;
            const preview = document.getElementById('frontPreview');
            preview.style.display = 'none';
            preview.onclick = null;
            document.getElementById('frontCropControls').style.display = 'none';
            document.getElementById('photoBox').classList.remove('has-image');
            document.getElementById('frontCameraInput').value = '';
            document.getElementById('frontGalleryInput').value = '';
        }

        async function handleLabelPhoto(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                originalLabelImage = event.target.result;
                labelImage = originalLabelImage;
                
                // Show preview
                const preview = document.getElementById('labelPreview');
                preview.src = labelImage;
                preview.style.display = 'block';
                preview.onclick = () => toggleZoom(preview);
                
                // Show crop controls
                document.getElementById('labelCropControls').style.display = 'block';
                
                // Setup canvas for cropping
                setupCropCanvas();
            };
            reader.readAsDataURL(file);
        }

        function toggleZoom(img) {
            const overlay = document.getElementById('zoomOverlay');
            img.classList.toggle('zoomed');
            overlay.classList.toggle('show');
        }

        function closeZoom() {
            document.querySelectorAll('.preview-image').forEach(img => {
                img.classList.remove('zoomed');
            });
            document.getElementById('zoomOverlay').classList.remove('show');
        }

        function setupCropCanvas() {
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas to actual image size
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw image at actual size
                ctx.drawImage(img, 0, 0);
                
                // Display canvas scaled to fit screen
                const maxWidth = Math.min(500, window.innerWidth - 60);
                canvas.style.maxWidth = maxWidth + 'px';
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
                canvas.style.display = 'block';
                
                console.log('Canvas actual size:', canvas.width, 'x', canvas.height);
                console.log('Canvas display size:', canvas.offsetWidth, 'x', canvas.offsetHeight);
                
                // Setup crop interaction
                canvas.onmousedown = startCrop;
                canvas.onmousemove = drawCrop;
                canvas.onmouseup = endCrop;
                canvas.ontouchstart = (e) => { e.preventDefault(); startCrop(e.touches[0]); };
                canvas.ontouchmove = (e) => { e.preventDefault(); drawCrop(e.touches[0]); };
                canvas.ontouchend = endCrop;
            };
            
            img.src = originalLabelImage;
        }

        function startCrop(e) {
            const canvas = document.getElementById('cropCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // Calculate scale ratio between display size and actual canvas size
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // Get coordinates relative to canvas display
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            // Convert to actual canvas coordinates
            cropStartX = (clientX - rect.left) * scaleX;
            cropStartY = (clientY - rect.top) * scaleY;
            
            isCropping = true;
            
            console.log('Start crop - Display:', (clientX - rect.left), (clientY - rect.top));
            console.log('Start crop - Canvas:', cropStartX, cropStartY);
            console.log('Scale:', scaleX, scaleY);
        }

        function drawCrop(e) {
            if (!isCropping) return;
            
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Calculate scale ratio
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // Get coordinates relative to canvas display
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            // Convert to actual canvas coordinates
            cropEndX = (clientX - rect.left) * scaleX;
            cropEndY = (clientY - rect.top) * scaleY;
            
            // Redraw image
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Draw crop rectangle at actual canvas coordinates
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 10]);
                ctx.strokeRect(
                    cropStartX, 
                    cropStartY, 
                    cropEndX - cropStartX, 
                    cropEndY - cropStartY
                );
                ctx.setLineDash([]);
                
                // Draw semi-transparent overlay outside crop area
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                
                const minX = Math.min(cropStartX, cropEndX);
                const minY = Math.min(cropStartY, cropEndY);
                const maxX = Math.max(cropStartX, cropEndX);
                const maxY = Math.max(cropStartY, cropEndY);
                
                // Top
                ctx.fillRect(0, 0, canvas.width, minY);
                // Left
                ctx.fillRect(0, minY, minX, maxY - minY);
                // Right
                ctx.fillRect(maxX, minY, canvas.width - maxX, maxY - minY);
                // Bottom
                ctx.fillRect(0, maxY, canvas.width, canvas.height - maxY);
            };
            img.src = originalLabelImage;
        }

        function endCrop() {
            isCropping = false;
            console.log('End crop at:', cropEndX, cropEndY);
        }

        function applyCrop() {
            const canvas = document.getElementById('cropCanvas');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                // Crop coordinates are already in actual image size
                const cropWidth = Math.abs(cropEndX - cropStartX);
                const cropHeight = Math.abs(cropEndY - cropStartY);
                const cropX = Math.min(cropStartX, cropEndX);
                const cropY = Math.min(cropStartY, cropEndY);
                
                console.log('Applying crop:', cropX, cropY, cropWidth, cropHeight);
                
                if (cropWidth > 10 && cropHeight > 10) {
                    // Apply crop
                    tempCanvas.width = cropWidth;
                    tempCanvas.height = cropHeight;
                    tempCtx.drawImage(
                        img, 
                        cropX, cropY, cropWidth, cropHeight,
                        0, 0, cropWidth, cropHeight
                    );
                    
                    labelImage = tempCanvas.toDataURL('image/jpeg', 0.95);
                    
                    // Update preview
                    document.getElementById('labelPreview').src = labelImage;
                    
                    console.log('Crop applied successfully');
                } else {
                    console.log('Crop area too small, using original image');
                }
                
                // Start OCR
                document.getElementById('labelCropControls').style.display = 'none';
                extractTextFromImage(labelImage);
            };
            img.src = originalLabelImage;
        }

        function skipCrop() {
            labelImage = originalLabelImage;
            document.getElementById('labelCropControls').style.display = 'none';
            extractTextFromImage(labelImage);
        }

        function retakeLabelPhoto() {
            labelImage = null;
            originalLabelImage = null;
            const preview = document.getElementById('labelPreview');
            preview.style.display = 'none';
            preview.onclick = null;
            document.getElementById('labelCropControls').style.display = 'none';
            document.getElementById('cropCanvas').style.display = 'none';
            document.getElementById('labelCameraInput').value = '';
            document.getElementById('labelGalleryInput').value = '';
        }

        function showOCR() {
            document.getElementById('ocrSection').style.display = 'block';
            document.getElementById('ocrTipBanner').style.display = 'none';
        }

        // ============= OCR =============
        async function extractTextFromImage(imageData) {
            const loading = document.getElementById('loadingOCR');
            loading.classList.add('show');

            try {
                // Preprocess image for better OCR
                const preprocessedImage = await preprocessImage(imageData);
                
                // Run OCR with multiple languages
                const result = await Tesseract.recognize(preprocessedImage, 'eng+ita', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            document.querySelector('.loading-text').textContent = `Lettura in corso... ${percent}%`;
                        }
                    }
                });

                const text = result.data.text;
                console.log('OCR Text:', text);
                parseNutritionValues(text);
                
            } catch (error) {
                console.error('Errore OCR:', error);
                alert('‚ö†Ô∏è Non riesco a leggere l\'etichetta.\n\nProva a:\n‚Ä¢ Ritagliare solo la tabella nutrizionale\n‚Ä¢ Scattare con pi√π luce\n‚Ä¢ Tenere il telefono dritto\n\nOppure inserisci i valori manualmente.');
            } finally {
                loading.classList.remove('show');
            }
        }

        async function preprocessImage(imageData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Convert to grayscale and increase contrast
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        
                        // Increase contrast
                        const contrast = 1.5;
                        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                        const newGray = factor * (gray - 128) + 128;
                        
                        // Clamp values
                        const finalGray = Math.max(0, Math.min(255, newGray));
                        
                        data[i] = data[i + 1] = data[i + 2] = finalGray;
                    }
                    
                    // Put processed image back
                    ctx.putImageData(imageData, 0, 0);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.95));
                };
                img.src = imageData;
            });
        }

        function parseNutritionValues(text) {
            // Aggressive pre-processing to handle line breaks and formatting
            let cleanText = text.toLowerCase();
            
            // Remove all hyphens followed by whitespace/newlines (line breaks)
            cleanText = cleanText.replace(/-[\s\n\r]+/g, '');
            
            // Remove standalone hyphens
            cleanText = cleanText.replace(/\s+-\s+/g, ' ');
            
            // Normalize all whitespace to single spaces
            cleanText = cleanText.replace(/[\n\r\t]+/g, ' ');
            cleanText = cleanText.replace(/\s+/g, ' ');
            
            console.log('=== OCR PARSING ===');
            console.log('Original text:', text);
            console.log('Cleaned text:', cleanText);
            
            // Improved patterns with multiple variations including formal Italian terms
            const patterns = {
                protein: [
                    /protein[ae]?\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /prot[.,\s]*(\d+[.,]?\d*)\s*%/i
                ],
                fat: [
                    /grass[io]\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /fat\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /lipid[ie]?\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /materia\s+grassa\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /tenore.*?grassa\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    // More flexible: any "grassa" followed by number
                    /grassa\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i
                ],
                fiber: [
                    /fibr[ae]\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /fiber\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /grezze\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i
                ],
                moisture: [
                    /umidit[a√†]\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /moisture\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /acqua\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i
                ],
                ash: [
                    /cener[ie]\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /ash\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /inorganica\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /materia\s+inorganica\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    // More flexible: "inorg" with OCR errors (0 instead of o, 1 instead of i)
                    /in[o0]rg[a@]nic[a@]\s*[:\-]?\s*(\d+[.,]?\d*)\s*%?/i,
                    /mat.*?in[o0]rg.*?\s*(\d+[.,]?\d*)\s*%?/i,
                    // Ultra flexible: just look for numbers near "inorg"
                    /in.{0,3}rg.{0,10}\s*(\d+[.,]?\d*)\s*%?/i
                ],
                kcal: [
                    /(\d+)\s*kcal/i,
                    /energia.*?(\d+)\s*kcal/i
                ]
            };

            let foundValues = {};
            let foundCount = 0;

            // Try each pattern for each nutrient
            for (const [key, patternList] of Object.entries(patterns)) {
                for (const pattern of patternList) {
                    const match = cleanText.match(pattern);
                    if (match) {
                        // Get the last captured group (the number)
                        let value = match[match.length - 1];
                        
                        console.log(`Pattern matched for ${key}: "${match[0]}" -> value: "${value}"`);
                        
                        // Handle OCR errors: O‚Üí0, l‚Üí1, S‚Üí5, I‚Üí1
                        value = value.replace(/o/gi, '0').replace(/[li]/gi, '1').replace(/s/gi, '5');
                        
                        // Convert comma to dot (Italian decimal separator)
                        value = value.replace(',', '.');
                        
                        // Remove any remaining non-numeric characters except dot
                        value = value.replace(/[^\d.]/g, '');
                        
                        const numValue = parseFloat(value);
                        
                        console.log(`Parsed number for ${key}: ${numValue}`);
                        
                        if (key === 'kcal') {
                            if (numValue > 50 && numValue < 600 && !foundValues[key]) {
                                foundValues[key] = numValue;
                                foundCount++;
                                console.log(`‚úì Found ${key}: ${numValue}`);
                                break;
                            }
                        } else {
                            if (numValue > 0 && numValue < 100 && !foundValues[key]) {
                                foundValues[key] = numValue;
                                foundCount++;
                                console.log(`‚úì Found ${key}: ${numValue}`);
                                break;
                            }
                        }
                    }
                }
                if (!foundValues[key]) {
                    console.log(`‚úó NOT found: ${key}`);
                }
            }

            console.log('=== FINAL RESULTS ===');
            console.log('Found values:', foundValues);
            console.log('Total found:', foundCount);

            // Apply found values to form
            if (foundValues.protein) document.getElementById('protein').value = foundValues.protein;
            if (foundValues.fat) document.getElementById('fat').value = foundValues.fat;
            if (foundValues.fiber) document.getElementById('fiber').value = foundValues.fiber;
            if (foundValues.moisture) document.getElementById('moisture').value = foundValues.moisture;
            if (foundValues.ash) document.getElementById('ash').value = foundValues.ash;
            if (foundValues.kcal) document.getElementById('kcalPer100g').value = foundValues.kcal;

            if (foundCount > 0) {
                // Highlight filled fields
                if (foundValues.protein) highlightField('protein');
                if (foundValues.fat) highlightField('fat');
                if (foundValues.fiber) highlightField('fiber');
                if (foundValues.moisture) highlightField('moisture');
                if (foundValues.ash) highlightField('ash');
                if (foundValues.kcal) highlightField('kcalPer100g');
                
                // Show success message
                const missingFields = [];
                if (!foundValues.protein) missingFields.push('Proteine');
                if (!foundValues.fat) missingFields.push('Grassi');
                if (!foundValues.fiber) missingFields.push('Fibre');
                if (!foundValues.moisture) missingFields.push('Umidit√†');
                
                let message = `‚úÖ Trovati ${foundCount} valori!\n\nVerifica che siano corretti.`;
                
                if (missingFields.length > 0) {
                    message += `\n\n‚ö†Ô∏è Mancano:\n${missingFields.join(', ')}`;
                    message += `\n\nInseriscili manualmente.`;
                }
                
                alert(message);
            } else {
                alert('‚ö†Ô∏è Nessun valore rilevato.\n\nProva a:\n‚Ä¢ Ritagliare meglio la tabella\n‚Ä¢ Scattare con pi√π luce\n‚Ä¢ Aprire la Console (F12) per vedere i dettagli\n‚Ä¢ Inserire i valori manualmente');
            }
        }

        function highlightField(fieldId) {
            const field = document.getElementById(fieldId);
            field.style.background = '#d4edda';
            field.style.borderColor = '#28a745';
            setTimeout(() => {
                field.style.background = '';
                field.style.borderColor = '';
            }, 3000);
        }

        // ============= FOOD ANALYSIS =============
        function analyzeFood() {
            // Validation
            const protein = parseFloat(document.getElementById('protein').value);
            const fat = parseFloat(document.getElementById('fat').value);
            const fiber = parseFloat(document.getElementById('fiber').value);
            const moisture = parseFloat(document.getElementById('moisture').value);

            if (!protein || !fat || !fiber || !moisture) {
                alert('‚ö†Ô∏è Inserisci tutti i valori obbligatori (Proteine, Grassi, Fibre, Umidit√†)');
                return;
            }

            // Smart validation
            const total = protein + fat + fiber + moisture;
            if (total > 100) {
                alert(`‚ö†Ô∏è Attenzione: la somma dei valori √® ${total.toFixed(1)}% (superiore a 100%). Verifica i dati.`);
                return;
            }

            // Get values
            const name = document.getElementById('foodName').value;
            const type = document.getElementById('foodType').value;
            
            // Auto ash estimation
            let ash = parseFloat(document.getElementById('ash').value);
            let ashEstimated = false;
            if (!ash || isNaN(ash)) {
                ash = type === 'dry' ? 5.0 : 2.0;
                ashEstimated = true;
            }

            // Calculate carbs
            const carbsAsFed = 100 - (protein + fat + fiber + moisture + ash);

            if (carbsAsFed < 0) {
                alert('‚ö†Ô∏è Errore: il totale supera il 100%. Verifica i valori.');
                return;
            }

            // Estimate or use provided kcal
            let kcalPer100g = parseFloat(document.getElementById('kcalPer100g').value);
            let kcalEstimated = false;
            if (!kcalPer100g || isNaN(kcalPer100g)) {
                kcalPer100g = (4 * protein) + (8.5 * fat) + (4 * carbsAsFed);
                kcalEstimated = true;
            }

            // Calculate metrics
            const dryMatter = 100 - moisture;
            const carbsDMB = (carbsAsFed / dryMatter) * 100;
            const proteinME = (4 * protein / kcalPer100g) * 100;
            const fatME = (8.5 * fat / kcalPer100g) * 100;
            const carbsME = (4 * carbsAsFed / kcalPer100g) * 100;
            const carbsPer100kcal = (carbsAsFed / kcalPer100g) * 100;
            const proteinPer100kcal = (protein / kcalPer100g) * 100;

            // Scoring
            let carbScore = 'grigio';
            let proteinScore = 'grigio';
            
            if (!kcalEstimated || !ashEstimated) {
                if (carbsME <= 12 || carbsPer100kcal <= 3) carbScore = 'verde';
                else if (carbsME <= 15 || carbsPer100kcal <= 5) carbScore = 'giallo';
                else carbScore = 'rosso';

                if (proteinME >= 40) proteinScore = 'verde';
                else if (proteinME >= 35) proteinScore = 'giallo';
                else proteinScore = 'rosso';
            }

            let overallScore = 'grigio';
            if (carbScore !== 'grigio' && proteinScore !== 'grigio') {
                if (carbScore === 'verde' && proteinScore === 'verde') overallScore = 'verde';
                else if (carbScore === 'rosso' || proteinScore === 'rosso') overallScore = 'rosso';
                else overallScore = 'giallo';
            }

            let confidence = 'alta';
            if (kcalEstimated && ashEstimated) confidence = 'bassa';
            else if (kcalEstimated || ashEstimated) confidence = 'media';

            // Store analysis
            currentAnalysis = {
                name, type, protein, fat, fiber, moisture, ash,
                carbsAsFed, carbsDMB, kcalPer100g,
                proteinME, fatME, carbsME,
                carbsPer100kcal, proteinPer100kcal,
                carbScore, proteinScore, overallScore, confidence,
                kcalEstimated, ashEstimated,
                frontImage, labelImage,
                date: new Date().toISOString()
            };

            displayResults(currentAnalysis);
            goToStep(3);
        }

        function displayResults(analysis) {
            const verdictConfig = {
                verde: {
                    emoji: '‚úÖ',
                    title: 'OTTIMO',
                    text: 'Perfetto per gatti diabetici! üéâ',
                    bg: 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)'
                },
                giallo: {
                    emoji: '‚ö†Ô∏è',
                    title: 'ACCETTABILE',
                    text: 'Va bene, ma ci sono opzioni migliori',
                    bg: 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)'
                },
                rosso: {
                    emoji: '‚ùå',
                    title: 'NON IDEALE',
                    text: 'Non √® l\'ideale per un gatto diabetico',
                    bg: 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)'
                },
                grigio: {
                    emoji: '‚ö™',
                    title: 'DATI INSUFFICIENTI',
                    text: 'Servono pi√π dati per valutare',
                    bg: 'linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%)'
                }
            };

            const verdict = verdictConfig[analysis.overallScore];
            const confidenceLabels = { alta: 'Alta', media: 'Media', bassa: 'Bassa' };

            let html = `
                <div class="verdict-card" style="background: ${verdict.bg};">
                    <div class="verdict-emoji">${verdict.emoji}</div>
                    <div class="verdict-title">${verdict.title}</div>
                    <div class="verdict-text">${verdict.text}</div>
                    <span class="info-icon" onclick="showInfo('scoring')" style="background: rgba(0,0,0,0.6); margin-top: 15px; display: inline-flex;">?</span>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="display: inline-block; padding: 8px 16px; border-radius: 8px; font-size: 15px; ${
                        analysis.confidence === 'alta' ? 'background: #d4edda; color: #155724;' :
                        analysis.confidence === 'media' ? 'background: #fff3cd; color: #856404;' :
                        'background: #f8d7da; color: #721c24;'
                    }">
                        Affidabilit√†: ${confidenceLabels[analysis.confidence]}
                    </span>
                    <span class="info-icon" onclick="showInfo('confidence')">?</span>
                </div>
            `;

            // Portion if profile exists
            if (catProfile && catProfile.targetKcal) {
                const gramsPerDay = (catProfile.targetKcal / analysis.kcalPer100g) * 100;
                html += `
                    <div class="portion-card">
                        <div class="portion-label">Porzione per ${catProfile.name}</div>
                        <div class="portion-value">${gramsPerDay.toFixed(0)}g</div>
                        <div class="portion-sub">al giorno (${catProfile.targetKcal} kcal)</div>
                    </div>
                `;
            }

            // Details with info icons and colored badges
            html += `
                <details style="margin-top: 20px;">
                    <summary>üìä Dettagli Nutrizionali</summary>
                    <div class="details-content">
                        <div class="metric-row">
                            <span>
                                Carboidrati %ME
                                <span class="info-icon" onclick="showInfo('carbsME')">?</span>
                            </span>
                            <strong>
                                ${analysis.carbsME.toFixed(1)}%
                                <span style="display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 13px; margin-left: 6px; background: ${
                                    analysis.carbScore === 'verde' ? 'var(--success)' :
                                    analysis.carbScore === 'giallo' ? 'var(--warning)' :
                                    analysis.carbScore === 'rosso' ? 'var(--danger)' : 'var(--gray-600)'
                                }; color: ${analysis.carbScore === 'giallo' ? 'var(--gray-900)' : 'white'};">
                                    ${analysis.carbScore === 'verde' ? '‚úì' : analysis.carbScore === 'giallo' ? '~' : analysis.carbScore === 'rosso' ? '‚úó' : '?'}
                                </span>
                            </strong>
                        </div>
                        <div class="metric-row">
                            <span>
                                Carboidrati g/100kcal
                                <span class="info-icon" onclick="showInfo('carbsGrams')">?</span>
                            </span>
                            <strong>${analysis.carbsPer100kcal.toFixed(1)}g</strong>
                        </div>
                        <div class="metric-row">
                            <span>
                                Proteine %ME
                                <span class="info-icon" onclick="showInfo('proteinME')">?</span>
                            </span>
                            <strong>
                                ${analysis.proteinME.toFixed(1)}%
                                <span style="display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 13px; margin-left: 6px; background: ${
                                    analysis.proteinScore === 'verde' ? 'var(--success)' :
                                    analysis.proteinScore === 'giallo' ? 'var(--warning)' :
                                    analysis.proteinScore === 'rosso' ? 'var(--danger)' : 'var(--gray-600)'
                                }; color: ${analysis.proteinScore === 'giallo' ? 'var(--gray-900)' : 'white'};">
                                    ${analysis.proteinScore === 'verde' ? '‚úì' : analysis.proteinScore === 'giallo' ? '~' : analysis.proteinScore === 'rosso' ? '‚úó' : '?'}
                                </span>
                            </strong>
                        </div>
                        <div class="metric-row">
                            <span>
                                Proteine g/100kcal
                                <span class="info-icon" onclick="showInfo('proteinGrams')">?</span>
                            </span>
                            <strong>${analysis.proteinPer100kcal.toFixed(1)}g</strong>
                        </div>
                        <div class="metric-row">
                            <span>Energia</span>
                            <strong>${analysis.kcalPer100g.toFixed(0)} kcal/100g</strong>
                        </div>
                    </div>
                </details>
            `;

            // Warnings
            if (analysis.type === 'dry' && analysis.overallScore === 'verde') {
                html += `
                    <div class="alert alert-warning" style="margin-top: 20px;">
                        <strong>‚ö†Ô∏è Cibo secco:</strong> Usa sempre una bilancia. Evita somministrazione ad libitum.
                    </div>
                `;
            }

            if (catProfile && catProfile.onInsulin) {
                html += `
                    <div class="alert alert-danger" style="margin-top: 15px;">
                        <strong>‚ö†Ô∏è Terapia insulinica:</strong> Consultare il veterinario prima di cambiare alimentazione.
                    </div>
                `;
            }

            document.getElementById('analysisResults').innerHTML = html;
        }

        // ============= SAVE FOOD =============
        function saveFood() {
            if (!currentAnalysis) return;

            let catalog = JSON.parse(localStorage.getItem('foodCatalog') || '[]');
            catalog.unshift(currentAnalysis);
            localStorage.setItem('foodCatalog', JSON.stringify(catalog));

            showSuccessAnimation();
            
            setTimeout(() => {
                resetWizard();
                switchTab('catalog');
            }, 1500);
        }

        // ============= CATALOG =============
        function loadCatalog() {
            const catalog = JSON.parse(localStorage.getItem('foodCatalog') || '[]');
            const foodList = document.getElementById('foodList');
            const tipBanner = document.getElementById('tipBanner');

            // Show tips
            if (catalog.length > 0) {
                const tips = [
                    { icon: 'üí°', title: 'Lo sapevi?', text: 'I gatti diabetici hanno bisogno di proteine alte e carboidrati bassi', link: 'Scopri perch√©', action: 'carbsME' },
                    { icon: '‚öñÔ∏è', title: 'Consiglio', text: 'Usa sempre una bilancia da cucina per pesare le porzioni con precisione', link: null, action: null },
                    { icon: 'üíä', title: 'Importante', text: 'Cambi nella dieta possono influenzare il fabbisogno di insulina', link: null, action: null }
                ];
                
                const randomTip = tips[Math.floor(Math.random() * tips.length)];
                tipBanner.innerHTML = `
                    <div class="tip-banner">
                        <div class="tip-icon">${randomTip.icon}</div>
                        <div class="tip-content">
                            <div class="tip-title">${randomTip.title}</div>
                            <div class="tip-text">
                                ${randomTip.text}
                                ${randomTip.link ? `<a href="#" class="tip-link" onclick="event.preventDefault(); showInfo('${randomTip.action}')">${randomTip.link} ‚Üí</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                tipBanner.innerHTML = '';
            }

            if (catalog.length === 0) {
                const hasProfile = catProfile && catProfile.targetKcal;
                foodList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-illustration">üìã</div>
                        <div class="empty-title">Catalogo vuoto</div>
                        ${!hasProfile ? `
                            <div class="alert alert-info" style="margin: 25px 0; text-align: left;">
                                <div class="alert-title">üëã Prima volta?</div>
                                1Ô∏è‚É£ Vai su <strong>Profilo</strong> e inserisci i dati<br>
                                2Ô∏è‚É£ Poi vai su <strong>Cibo</strong> per analizzare<br>
                                3Ô∏è‚É£ I cibi salvati appariranno qui!
                            </div>
                        ` : `
                            <div class="empty-text">
                                Analizza un cibo nella tab "Cibo"<br>per iniziare il tuo catalogo
                            </div>
                            <div class="empty-action">
                                <button class="btn btn-primary" onclick="switchTab('food')">
                                    ‚ûï Aggiungi Primo Cibo
                                </button>
                            </div>
                        `}
                    </div>
                `;
                return;
            }

            const scoreLabels = {
                verde: '‚úÖ OTTIMO',
                giallo: '‚ö†Ô∏è ACCETTABILE',
                rosso: '‚ùå NON IDEALE',
                grigio: '‚ö™ DATI INSUFF.'
            };

            foodList.innerHTML = catalog.map((food, index) => {
                const portion = catProfile && catProfile.targetKcal ? 
                    ((catProfile.targetKcal / food.kcalPer100g) * 100).toFixed(0) : null;

                return `
                    <div class="food-card">
                        <div class="food-card-header">
                            ${food.frontImage ? 
                                `<img src="${food.frontImage}" class="food-image" alt="${food.name}">` : 
                                `<div class="food-image">üê±</div>`
                            }
                            <div class="food-info">
                                <div class="food-name">${food.name}</div>
                                <div class="food-type">
                                    ${food.type === 'dry' ? 'üü§ Secco' : 'üü¶ Umido'} ‚Ä¢ 
                                    ${food.kcalPer100g.toFixed(0)} kcal/100g
                                </div>
                                <div class="food-score ${food.overallScore}">
                                    ${scoreLabels[food.overallScore]}
                                </div>
                            </div>
                        </div>

                        ${portion ? `
                            <div class="food-portion">
                                <div>
                                    <div style="font-size: 14px; color: var(--gray-600);">Porzione giornaliera</div>
                                    <div class="portion-amount">${portion}g</div>
                                </div>
                                <button class="use-today-btn" onclick="useToday('${food.name}', ${portion})">
                                    Usa oggi
                                </button>
                            </div>
                        ` : ''}

                        <details>
                            <summary>üìä Dettagli</summary>
                            <div class="details-content">
                                <div class="metric-row">
                                    <span>Carboidrati</span>
                                    <strong>${food.carbsME.toFixed(1)}% ME ‚Ä¢ ${food.carbsPer100kcal.toFixed(1)}g/100kcal</strong>
                                </div>
                                <div class="metric-row">
                                    <span>Proteine</span>
                                    <strong>${food.proteinME.toFixed(1)}% ME ‚Ä¢ ${food.proteinPer100kcal.toFixed(1)}g/100kcal</strong>
                                </div>
                            </div>
                        </details>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="delete-btn" onclick="deleteFood(${index})" style="flex: 1;">
                                üóëÔ∏è Elimina
                            </button>
                            <button class="delete-btn" onclick="openShare(${index})" style="flex: 1; background: var(--primary);">
                                üì§ Condividi
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function useToday(name, grams) {
            alert(`üìã ${name}\n\nüçΩÔ∏è Dai ${grams}g oggi\n\nDividi in 2-3 pasti durante la giornata.`);
        }

        function deleteFood(index) {
            if (!confirm('Eliminare questo cibo dal catalogo?')) return;

            let catalog = JSON.parse(localStorage.getItem('foodCatalog') || '[]');
            catalog.splice(index, 1);
            localStorage.setItem('foodCatalog', JSON.stringify(catalog));
            loadCatalog();
        }

        // ============= SHARE =============
        function openShare(index) {
            const catalog = JSON.parse(localStorage.getItem('foodCatalog') || '[]');
            const food = catalog[index];
            
            const scoreText = {
                verde: '‚úÖ OTTIMO per diabetici',
                giallo: '‚ö†Ô∏è ACCETTABILE',
                rosso: '‚ùå NON IDEALE per diabetici',
                grigio: '‚ö™ DATI INSUFFICIENTI'
            };

            const portion = catProfile && catProfile.targetKcal ? 
                `\nPorzione: ${((catProfile.targetKcal / food.kcalPer100g) * 100).toFixed(0)}g/giorno` : '';

            shareData = `${food.name}\n${scoreText[food.overallScore]}${portion}\n\nCarboidrati: ${food.carbsPer100kcal.toFixed(1)}g/100kcal\nProteine: ${food.proteinPer100kcal.toFixed(1)}g/100kcal`;

            document.getElementById('shareSheet').classList.add('show');
        }

        function closeShare() {
            document.getElementById('shareSheet').classList.remove('show');
        }

        function shareVia(method) {
            if (!shareData) return;

            if (method === 'whatsapp') {
                window.open(`https://wa.me/?text=${encodeURIComponent(shareData)}`);
            } else if (method === 'email') {
                window.location.href = `mailto:?subject=Analisi Cibo Gatto&body=${encodeURIComponent(shareData)}`;
            } else if (method === 'copy') {
                navigator.clipboard.writeText(shareData).then(() => {
                    alert('‚úÖ Copiato negli appunti!');
                });
            }

            closeShare();
        }

        // ============= PROFILE =============
        function saveProfile() {
            const name = document.getElementById('catName').value || 'Gatto';
            const currentWeight = parseFloat(document.getElementById('currentWeight').value);
            
            if (!currentWeight || currentWeight <= 0) {
                alert('‚ö†Ô∏è Inserisci un peso valido');
                return;
            }

            const profile = {
                name,
                currentWeight,
                idealWeight: parseFloat(document.getElementById('idealWeight').value) || currentWeight,
                status: document.getElementById('catStatus').value,
                goal: document.getElementById('goal').value,
                onInsulin: document.getElementById('onInsulin').checked
            };

            const weight = profile.goal === 'weight-loss' ? profile.idealWeight : profile.currentWeight;
            const RER = 70 * Math.pow(weight, 0.75);
            
            let targetKcal;
            if (profile.goal === 'weight-loss') {
                targetKcal = 0.8 * RER;
            } else {
                targetKcal = profile.status === 'neutered' ? 1.2 * RER : 1.4 * RER;
            }

            profile.targetKcal = Math.round(targetKcal);
            profile.RER = Math.round(RER);

            catProfile = profile;
            localStorage.setItem('catProfile', JSON.stringify(profile));

            document.getElementById('profileSummary').style.display = 'block';
            document.getElementById('profileCalories').innerHTML = `
                <div style="font-size: 20px; margin: 10px 0;">
                    <strong>${profile.targetKcal}</strong> kcal/giorno
                </div>
                <div style="font-size: 16px; opacity: 0.9;">
                    RER: ${profile.RER} kcal ‚Ä¢ ${profile.goal === 'weight-loss' ? 'üéØ Dimagrimento' : '‚úÖ Mantenimento'}
                </div>
            `;

            showSuccessAnimation();
        }

        function loadProfile() {
            const saved = localStorage.getItem('catProfile');
            if (saved) {
                catProfile = JSON.parse(saved);
                document.getElementById('catName').value = catProfile.name || '';
                document.getElementById('currentWeight').value = catProfile.currentWeight;
                document.getElementById('idealWeight').value = catProfile.idealWeight;
                document.getElementById('catStatus').value = catProfile.status;
                document.getElementById('goal').value = catProfile.goal;
                document.getElementById('onInsulin').checked = catProfile.onInsulin;
                
                if (catProfile.onInsulin) {
                    document.getElementById('insulinWarning').classList.remove('hidden');
                }

                if (catProfile.targetKcal) {
                    document.getElementById('profileSummary').style.display = 'block';
                    document.getElementById('profileCalories').innerHTML = `
                        <div style="font-size: 20px; margin: 10px 0;">
                            <strong>${catProfile.targetKcal}</strong> kcal/giorno
                        </div>
                        <div style="font-size: 16px; opacity: 0.9;">
                            RER: ${catProfile.RER} kcal
                        </div>
                    `;
                }
            }
        }

        function deleteProfile() {
            if (!confirm('Eliminare il profilo del gatto?\n\nI cibi nel catalogo non verranno eliminati.')) return;

            localStorage.removeItem('catProfile');
            catProfile = null;

            document.getElementById('catName').value = '';
            document.getElementById('currentWeight').value = '5.0';
            document.getElementById('idealWeight').value = '5.0';
            document.getElementById('catStatus').value = 'neutered';
            document.getElementById('goal').value = 'maintenance';
            document.getElementById('onInsulin').checked = false;
            document.getElementById('insulinWarning').classList.add('hidden');
            document.getElementById('profileSummary').style.display = 'none';

            alert('‚úÖ Profilo eliminato!');
        }

        // ============= SETTINGS =============
        function loadSettings() {
            const extraLarge = localStorage.getItem('extraLargeText') === 'true';
            document.getElementById('extraLargeText').checked = extraLarge;
            if (extraLarge) {
                document.body.classList.add('extra-large-text');
            }
        }

        function toggleTextSize() {
            const isChecked = document.getElementById('extraLargeText').checked;
            localStorage.setItem('extraLargeText', isChecked);
            document.body.classList.toggle('extra-large-text', isChecked);
        }

        // ============= INFO SYSTEM =============
        const infoContent = {
            energy: {
                title: "Fabbisogno Energetico",
                text: `<p class="modal-text">Il fabbisogno energetico √® la quantit√† di calorie (kcal) che il tuo gatto ha bisogno ogni giorno per mantenersi in salute.</p>
                <p class="modal-text"><strong>RER (Resting Energy Requirement)</strong> √® l'energia di base che il gatto usa solo per vivere, respirare e mantenere la temperatura corporea - come se dormisse tutto il giorno.</p>
                <p class="modal-text"><strong>Fabbisogno totale</strong> √® il RER moltiplicato per un fattore che dipende dallo stile di vita del gatto (attivo, sterilizzato, ecc.).</p>
                <div class="modal-example">
                    <strong>Esempio pratico:</strong><br>
                    Un gatto sterilizzato di 5 kg ha bisogno di circa 240 kcal al giorno.<br>
                    Se vuoi farlo dimagrire, usi meno calorie (circa 190 kcal/giorno).
                </div>`
            },
            carbsME: {
                title: "Carboidrati %ME",
                text: `<p class="modal-text"><strong>%ME</strong> significa "percentuale di energia metabolizzabile" - cio√® quanta energia (calorie) viene dai carboidrati rispetto al totale.</p>
                <p class="modal-text">I gatti sono carnivori e hanno bisogno di pochi carboidrati. Per i gatti diabetici, √® importante che <strong>meno del 12% delle calorie</strong> venga dai carboidrati.</p>
                <div class="modal-example">
                    <strong>Perch√© √® importante:</strong><br>
                    I carboidrati aumentano lo zucchero nel sangue pi√π delle proteine o dei grassi. Per un gatto diabetico, meno carboidrati = zucchero pi√π stabile = meno insulina necessaria.
                </div>
                <p class="modal-text"><strong>Verde (‚â§12%):</strong> Ottimo per diabetici<br>
                <strong>Giallo (12-15%):</strong> Accettabile<br>
                <strong>Rosso (>15%):</strong> Troppi carboidrati</p>`
            },
            carbsGrams: {
                title: "Carboidrati g/100 kcal",
                text: `<p class="modal-text">Questo numero dice quanti <strong>grammi di carboidrati</strong> ci sono in 100 calorie di cibo.</p>
                <p class="modal-text">√à un altro modo per misurare i carboidrati, pi√π preciso per confrontare cibi umidi e secchi che hanno calorie molto diverse.</p>
                <div class="modal-example">
                    <strong>Obiettivo per gatti diabetici:</strong><br>
                    Massimo 3 grammi di carboidrati ogni 100 calorie.<br><br>
                    Se il cibo ha 5g/100kcal, vuol dire che √® troppo ricco di carboidrati per un diabetico.
                </div>
                <p class="modal-text"><strong>Verde (‚â§3g):</strong> Ottimo<br>
                <strong>Giallo (3-5g):</strong> Accettabile<br>
                <strong>Rosso (>5g):</strong> Troppo</p>`
            },
            proteinME: {
                title: "Proteine %ME",
                text: `<p class="modal-text">Indica quanta energia (calorie) viene dalle proteine rispetto al totale del cibo.</p>
                <p class="modal-text">I gatti sono carnivori obbligati e hanno bisogno di <strong>molte proteine</strong>. Per i gatti diabetici √® ancora pi√π importante: le proteine aiutano a mantenere i muscoli e non alzano lo zucchero nel sangue.</p>
                <div class="modal-example">
                    <strong>Obiettivo per gatti diabetici:</strong><br>
                    Almeno il 40% delle calorie dovrebbe venire dalle proteine.<br><br>
                    Pi√π proteine = pi√π saziet√†, muscoli forti, zucchero stabile.
                </div>
                <p class="modal-text"><strong>Verde (‚â•40%):</strong> Ottimo<br>
                <strong>Giallo (35-40%):</strong> Accettabile<br>
                <strong>Rosso (<35%):</strong> Troppo poche</p>`
            },
            proteinGrams: {
                title: "Proteine g/100 kcal",
                text: `<p class="modal-text">Quanti <strong>grammi di proteine</strong> ci sono in 100 calorie di cibo.</p>
                <p class="modal-text">Questo numero √® importante soprattutto se il gatto deve dimagrire: serve abbastanza proteine per non perdere i muscoli mentre perde peso.</p>
                <div class="modal-example">
                    <strong>Obiettivo minimo:</strong> 8.9 grammi/100 kcal<br>
                    <strong>Ideale per dimagrimento:</strong> 10+ grammi/100 kcal<br><br>
                    Questo garantisce che il gatto perda grasso, non muscoli.
                </div>`
            },
            scoring: {
                title: "Come Funziona il Punteggio",
                text: `<p class="modal-text">L'app valuta il cibo su due criteri principali per gatti diabetici:</p>
                <p class="modal-text"><strong>1. Carboidrati</strong> (devono essere pochi)<br>
                <strong>2. Proteine</strong> (devono essere tante)</p>
                <div class="modal-example">
                    <strong>üü¢ VERDE (Ottimo):</strong><br>
                    ‚Ä¢ Carboidrati ‚â§12% ME o ‚â§3g/100kcal<br>
                    ‚Ä¢ Proteine ‚â•40% ME<br>
                    ‚ûú Ideale per gatti diabetici<br><br>
                    
                    <strong>üü° GIALLO (Accettabile):</strong><br>
                    ‚Ä¢ Carboidrati 12-15% ME<br>
                    ‚Ä¢ Proteine 35-40% ME<br>
                    ‚ûú Va bene ma non ottimale<br><br>
                    
                    <strong>üî¥ ROSSO (Non ideale):</strong><br>
                    ‚Ä¢ Carboidrati >15% ME o >5g/100kcal<br>
                    ‚Ä¢ Proteine <35% ME<br>
                    ‚ûú Troppi carboidrati o poche proteine<br><br>
                    
                    <strong>‚ö™ GRIGIO (Dati insufficienti):</strong><br>
                    ‚Ä¢ Mancano troppi dati per valutare<br>
                    ‚ûú Cerca etichetta pi√π completa
                </div>
                <p class="modal-text">Il punteggio finale √® il peggiore tra carboidrati e proteine. Se uno √® rosso, il totale √® rosso.</p>`
            },
            confidence: {
                title: "Affidabilit√† del Calcolo",
                text: `<p class="modal-text">L'affidabilit√† indica quanto possiamo fidarci dei calcoli, in base ai dati disponibili sull'etichetta.</p>
                <div class="modal-example">
                    <strong>üü¢ ALTA:</strong><br>
                    Tutte le informazioni sono dichiarate sulla confezione (energia + ceneri).<br>
                    I calcoli sono molto precisi.<br><br>
                    
                    <strong>üü° MEDIA:</strong><br>
                    Manca l'energia OPPURE le ceneri, ma non entrambe.<br>
                    L'app stima il dato mancante con formule standard.<br>
                    I calcoli sono abbastanza precisi.<br><br>
                    
                    <strong>üî¥ BASSA:</strong><br>
                    Mancano sia l'energia che le ceneri.<br>
                    L'app deve stimare entrambi i valori.<br>
                    I calcoli sono meno precisi ma utili per orientarsi.
                </div>
                <p class="modal-text"><strong>Consiglio:</strong> Con affidabilit√† bassa, prova a cercare l'etichetta completa sul sito del produttore.</p>`
            }
        };

        function showInfo(topic) {
            const content = infoContent[topic];
            if (!content) return;

            document.getElementById('modalBody').innerHTML = `
                <div class="modal-title">${content.title}</div>
                ${content.text}
            `;
            document.getElementById('infoModal').classList.add('show');
        }

        function closeInfo() {
            document.getElementById('infoModal').classList.remove('show');
        }

        // ============= ANIMATIONS =============
        function showSuccessAnimation() {
            const animation = document.getElementById('successAnimation');
            animation.classList.add('show');
            
            // Haptic feedback if supported
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            setTimeout(() => {
                animation.classList.remove('show');
            }, 1500);
        }

        function showSuccess(message) {
            alert(message);
        }
    </script>

    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", async () => {
            try {
                const reg = await navigator.serviceWorker.register("/miaocarb/sw.js", {
                scope: "/miaocarb/"
                });
                console.log("SW OK scope:", reg.scope);
            } catch (e) {
                console.log("SW FAIL:", e);
            }
            });
        }
    </script>

</body>
</html>
