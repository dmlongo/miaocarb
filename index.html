<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiaoCarb</title>
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="assets/icon-192.png">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üê± Cibo per Diabetici</h1>
            <p>Analisi e porzioni personalizzate</p>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('catalog', this)">
                    <span class="tab-icon">üìö</span>
                    <span>Catalogo</span>
                </button>
                <button class="tab" onclick="switchTab('food', this)">
                    <span class="tab-icon">üçΩÔ∏è</span>
                    <span>Cibo</span>
                </button>
                <button class="tab" onclick="switchTab('profile', this)">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span>Profilo</span>
                </button>
            </div>

            <!-- CATALOG TAB -->
            <div id="catalog" class="tab-content active">
                <div id="tipBanner"></div>
                <div id="foodList"></div>
            </div>

            <!-- FOOD TAB with WIZARD -->
            <div id="food" class="tab-content">
                <!-- Step 1: Basic Info -->
                <div id="foodStep1" class="wizard active">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator"></div>
                        <div class="wizard-step-indicator"></div>
                    </div>

                    <div class="section-title">Informazioni Base</div>

                    <div class="form-group">
                        <label for="foodName">Nome Prodotto *</label>
                        <input type="text" id="foodName" placeholder="es. Royal Canin Diabetic" required>
                        <p class="error-message" id="nameError">Inserisci il nome del prodotto</p>
                    </div>

                    <div class="photo-box" id="photoBox">
                        <h4>üì¶ Foto Confezione</h4>
                        <p class="photo-tip">Per riconoscere il prodotto</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" type="button"
                                onclick="document.getElementById('frontCameraInput').click()" style="flex: 1;">
                                üì∑ Scatta
                            </button>
                            <button class="btn btn-secondary" type="button"
                                onclick="document.getElementById('frontGalleryInput').click()" style="flex: 1;">
                                üñºÔ∏è Galleria
                            </button>
                        </div>
                        <input type="file" id="frontCameraInput" class="camera-input" accept="image/*" capture>
                        <input type="file" id="frontGalleryInput" class="camera-input" accept="image/*">
                        <img id="frontPreview" class="preview-image" alt="Confezione">
                        <div id="frontCropControls" style="display: none; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="confirmFrontPhoto()" style="margin-bottom: 10px;">
                                ‚úì Usa Questa Foto
                            </button>
                            <button class="btn btn-secondary" onclick="retakeFrontPhoto()">
                                ‚Üª Rifai Foto
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="foodType">Tipo Cibo *</label>
                        <select id="foodType">
                            <option value="wet">üü¶ Umido</option>
                            <option value="dry">üü§ Secco</option>
                        </select>
                    </div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-next" onclick="goToStep(2)">
                            Avanti ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 2: Nutrients -->
                <div id="foodStep2" class="wizard">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator"></div>
                    </div>

                    <div class="section-title">Valori Nutrizionali</div>

                    <div class="tip-banner" id="ocrTipBanner" style="display: none;">
                        <div class="tip-icon">üí°</div>
                        <div class="tip-content">
                            <div class="tip-title">Prova la lettura automatica!</div>
                            <div class="tip-text">
                                <a href="#" class="tip-link" onclick="showOCR(); return false;">Scatta foto
                                    dell'etichetta</a> e proviamo a leggere i valori
                            </div>
                        </div>
                    </div>

                    <div id="ocrSection" style="display: none;">
                        <div class="photo-box">
                            <h4>üè∑Ô∏è Foto Etichetta Nutrizionale</h4>
                            <p class="photo-tip">üìê Inquadra SOLO la tabella nutrizionale per risultati migliori</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" type="button"
                                    onclick="document.getElementById('labelCameraInput').click()" style="flex: 1;">
                                    üì∑ Scatta
                                </button>
                                <button class="btn btn-secondary" type="button"
                                    onclick="document.getElementById('labelGalleryInput').click()" style="flex: 1;">
                                    üñºÔ∏è Galleria
                                </button>
                            </div>
                            <input type="file" id="labelCameraInput" class="camera-input" accept="image/*" capture>
                            <input type="file" id="labelGalleryInput" class="camera-input" accept="image/*">
                            <img id="labelPreview" class="preview-image" alt="Etichetta">

                            <div id="labelCropControls" style="display: none; margin-top: 15px;">
                                <div id="cropStage" class="crop-stage">
                                    <canvas id="cropBaseCanvas"></canvas>
                                    <canvas id="cropOverlayCanvas"></canvas>
                                </div>
                                <div style="margin-top: 15px;">
                                    <p style="font-size: 14px; color: var(--gray-600); margin-bottom: 10px;">
                                        üí° Clicca e trascina per ritagliare solo la tabella nutrizionale
                                    </p>
                                    <button class="btn btn-primary" onclick="applyCrop()" style="margin-bottom: 10px;">
                                        ‚úÇÔ∏è Ritaglia e Analizza
                                    </button>
                                    <button class="btn btn-secondary" onclick="skipCrop()" style="margin-bottom: 10px;">
                                        ‚è≠Ô∏è Salta Ritaglio
                                    </button>
                                    <button class="btn btn-secondary" onclick="retakeLabelPhoto()">
                                        ‚Üª Rifai Foto
                                    </button>
                                </div>
                            </div>

                            <div class="loading" id="loadingOCR">
                                <div class="spinner"></div>
                                <div class="loading-text">Lettura in corso...</div>
                            </div>
                        </div>
                    </div>

                    <p style="font-size: 16px; color: var(--gray-600); margin-bottom: 15px;">
                        Inserisci i valori % come indicato sulla confezione
                    </p>

                    <div class="nutrition-grid">
                        <div class="form-group">
                            <label for="protein">Proteine (Protein) % *</label>
                            <input type="number" id="protein" step="0.1" placeholder="es. 38" required>
                        </div>

                        <div class="form-group">
                            <label for="fat">Grassi (Fat) % *</label>
                            <input type="number" id="fat" step="0.1" placeholder="es. 8.5" required>
                        </div>

                        <div class="form-group">
                            <label for="fiber">Fibre (Fiber) % *</label>
                            <input type="number" id="fiber" step="0.1" placeholder="es. 4.3" required>
                        </div>

                        <div class="form-group">
                            <label for="moisture">Umidit√† (Moisture) % *</label>
                            <input type="number" id="moisture" step="0.1" placeholder="es. 12" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ash">Ceneri (Ash) %</label>
                        <input type="number" id="ash" step="0.1" placeholder="es. 6">
                        <p class="helper-text">Se indicato sulla confezione, inseriscilo qui</p>
                    </div>

                    <!-- Advanced section -->
                    <div class="advanced-section">
                        <div class="advanced-toggle" onclick="toggleAdvanced()">
                            <span id="advancedArrow">‚ñ∂</span>
                            <span>Opzioni Avanzate</span>
                        </div>
                        <div class="advanced-content" id="advancedContent">
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="kcalPer100g">Energia (kcal/100g)</label>
                                <input type="number" id="kcalPer100g" step="0.1" placeholder="Solo se dichiarato">
                                <p class="helper-text">Lascia vuoto per calcolo automatico</p>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-back" onclick="goToStep(1)">
                            ‚Üê Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-next" onclick="analyzeFood()">
                            Analizza ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div id="foodStep3" class="wizard">
                    <div class="wizard-progress">
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                        <div class="wizard-step-indicator completed"></div>
                    </div>

                    <div id="analysisResults"></div>

                    <div class="wizard-buttons">
                        <button class="wizard-btn wizard-btn-back" onclick="goToStep(2)">
                            ‚Üê Modifica
                        </button>
                        <button class="wizard-btn wizard-btn-next" onclick="saveFood()">
                            üíæ Salva
                        </button>
                    </div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile" class="tab-content">
                <div class="section-title">Profilo del Gatto</div>

                <!-- Simple mode -->
                <div id="simpleProfile">
                    <div class="form-group">
                        <label for="catName">Nome</label>
                        <input type="text" id="catName" placeholder="es. Micio">
                    </div>

                    <div class="form-group">
                        <label for="currentWeight">Peso (kg) *</label>
                        <input type="number" id="currentWeight" step="0.1" value="5.0" required>
                    </div>

                    <div style="background: var(--gray-50); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">üíä</span>
                            <div>
                                <div style="font-weight: 600; font-size: 17px;">Gatto diabetico</div>
                                <div style="font-size: 14px; color: var(--gray-600);">App dedicata a gatti con diabete
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced section -->
                <div class="advanced-section">
                    <div class="advanced-toggle" onclick="toggleProfileAdvanced()">
                        <span id="profileAdvancedArrow">‚ñ∂</span>
                        <span>Impostazioni Avanzate</span>
                    </div>
                    <div class="advanced-content" id="profileAdvancedContent">
                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="idealWeight">Peso Ideale (kg)</label>
                                <input type="number" id="idealWeight" step="0.1" value="5.0">
                                <p class="helper-text">Per calcolare porzioni in dimagrimento</p>
                            </div>

                            <div class="form-group">
                                <label for="catStatus">Stato</label>
                                <select id="catStatus">
                                    <option value="neutered">Sterilizzato</option>
                                    <option value="intact">Intero</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="goal">Obiettivo</label>
                                <select id="goal">
                                    <option value="maintenance">Mantenimento peso</option>
                                    <option value="weight-loss">Dimagrimento</option>
                                </select>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="onInsulin">
                                <label for="onInsulin">In terapia insulinica</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-danger hidden" id="insulinWarning">
                    <div class="alert-title">‚ö†Ô∏è ATTENZIONE - Terapia Insulinica</div>
                    Qualsiasi cambio di dieta pu√≤ richiedere aggiustamento dell'insulina. Consultare sempre il
                    veterinario prima di modificare l'alimentazione.
                </div>

                <button class="btn btn-primary" onclick="saveProfile()">üíæ Salva Profilo</button>
                <button class="btn btn-danger" onclick="deleteProfile()" style="margin-top: 15px;">üóëÔ∏è Elimina
                    Profilo</button>

                <div id="profileSummary" style="display: none; margin-top: 25px;">
                    <div class="portion-card">
                        <div class="portion-label">
                            Fabbisogno Energetico
                            <span class="info-icon" onclick="showInfo('energy')">?</span>
                        </div>
                        <div id="profileCalories"></div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="section-title" style="margin-top: 40px;">Impostazioni App</div>

                <div class="settings-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="settings-label">Testo Extra Large</div>
                            <p style="font-size: 14px; color: var(--gray-600);">Per una lettura pi√π facile</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="extraLargeText" onchange="toggleTextSize()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding -->
    <div class="onboarding" id="onboarding">
        <div class="onboarding-content" id="onboardingScreen1">
            <div class="onboarding-illustration">üê±</div>
            <h2>Benvenuta!</h2>
            <p class="onboarding-text">
                Ti aiutiamo a scegliere il cibo migliore per il tuo gatto diabetico
            </p>
            <div class="onboarding-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="skip-btn" onclick="skipOnboarding()">Salta</button>
            <button class="next-btn" onclick="nextOnboarding(2)">Inizia ‚Üí</button>
        </div>
    </div>

    <div class="onboarding" id="onboarding2">
        <div class="onboarding-content">
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="step-number">1Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Crea il profilo</strong><br>
                        Nome e peso del gatto
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="step-number">2Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Fotografa il cibo</strong><br>
                        Inseriamo i valori nutrizionali
                    </div>
                </div>
                <div class="onboarding-step">
                    <div class="step-number">3Ô∏è‚É£</div>
                    <div class="step-text">
                        <strong>Vedi se √® adatto</strong><br>
                        Punteggio e porzione giusta
                    </div>
                </div>
            </div>
            <div class="onboarding-dots">
                <div class="dot"></div>
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="skip-btn" onclick="skipOnboarding()">Salta</button>
            <button class="next-btn" onclick="nextOnboarding(3)">Avanti ‚Üí</button>
        </div>
    </div>

    <div class="onboarding" id="onboarding3">
        <div class="onboarding-content">
            <div class="onboarding-illustration">üí°</div>
            <h2>Consiglio!</h2>
            <p class="onboarding-text">
                Salva i cibi che usi sempre nel catalogo.<br><br>
                Cos√¨ trovi subito le porzioni senza ricalcolare ogni volta!
            </p>
            <div class="onboarding-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot active"></div>
            </div>
        </div>
        <div class="onboarding-buttons">
            <button class="next-btn" style="flex: 1;" onclick="completeOnboarding()">Inizia! üéâ</button>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeInfo()">&times;</button>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Success Animation -->
    <div class="success-animation" id="successAnimation">
        <div class="success-checkmark">‚úì</div>
        <div class="success-text">Salvato!</div>
    </div>

    <!-- Share Sheet -->
    <div class="share-sheet" id="shareSheet">
        <h3 style="margin-bottom: 10px;">Condividi</h3>
        <div class="share-options">
            <div class="share-option" onclick="shareVia('whatsapp')">
                <div class="share-icon">üí¨</div>
                <div class="share-label">WhatsApp</div>
            </div>
            <div class="share-option" onclick="shareVia('email')">
                <div class="share-icon">üìß</div>
                <div class="share-label">Email</div>
            </div>
            <div class="share-option" onclick="shareVia('copy')">
                <div class="share-icon">üìã</div>
                <div class="share-label">Copia</div>
            </div>
            <div class="share-option" onclick="closeShare()">
                <div class="share-icon">‚úï</div>
                <div class="share-label">Chiudi</div>
            </div>
        </div>
    </div>

    <!-- Zoom Overlay -->
    <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoom()"></div>

    <script src="js/storage.js"></script>
    <script src="js/idb.js"></script>
    <script src="js/app.js"></script>

</body>

</html>